# 产品需求文档 (PRD):  数据可视化应用发布与管理平台 (V1.0)

# 1.  引言

## 1.1.  背景

当前需要快速搭建一个数据可视化平台，用于在受限的企业私有云环境中发布和管理数据可视化应用。由于环境和时间限制，需要采用轻量级、高效的技术方案，并简化持久化和复杂的数据库交互。本平台旨在提供一个自助式的可视化应用发布和管理能力，降低可视化应用开发的门槛。

## 1.2.  目标

*   **核心目标:**  在受限环境下，快速搭建一个可用的数据可视化应用发布和管理平台。
*   **短期目标 (V1.0):**
    *   实现可视化应用的配置、发布和管理功能。
    *   支持多种数据源和图表引擎的灵活配置。
    *   提供应用开发+预览功能。
    *   提供简单的网格化Dashboard故事板功能.
    *   提供可视化应用的PDF导出, 包括Dashboard导出.
    *   具备Webhook集成能力，将PDF文件推送至指定平台。
    *   实现简单的用户认证（管理员用户）。

## 1.3.  非目标 (V1.0)

*   **复杂的数据源支持:**  V1.0 暂不考虑直接SQL查询数据库。
*   **精细化的权限管理:**  V1.0 仅支持管理员用户，不进行更细粒度的权限控制。
*   **完善的持久化:**  V1.0 允许重启后数据丢失，数据持久化不是首要目标，但应用配置数据需要基本保存 (例如使用文件存储或简单的内存数据库).
*   **复杂的布局和样式定制:**  V1.0 侧重于核心功能，布局和样式由用户脚本控制。

# 2.  用户

*   **目标用户:**  全栈 Web 工程师 (即开发者本人) 作为管理员用户。
*   **用户画像:**
    *   具备 Web 开发经验，熟悉 HTML, CSS, JavaScript。
    *   了解数据可视化原理和常用的图表库。
    *   需要在受限环境下快速部署和管理可视化应用。

# 3.  用户故事

*   作为管理员，我希望能够 **创建新的可视化应用**，以便快速发布我的数据可视化作品。
*   作为管理员，我希望能够 **配置可视化应用的数据源**，以便应用可以展示不同的数据。
*   作为管理员，我希望能够 **配置可视化应用的图表引擎和脚本**，以便灵活选择和定制图表样式。
*   作为管理员，我希望能够 **将可视化应用另存为模板**，以便快速创建类似的应用。
*   作为管理员，我希望能够 **管理已发布的可视化应用**，例如修改配置、删除应用等。
*   作为管理员，我希望能够 **创建一个 Dashboard**，集中展示和管理多个可视化应用。
*   作为管理员，我希望能够 **将可视化应用或Dashboard导出为 PDF**，以便离线分享或存档。* 
*   作为管理员，我希望能够 **配置 Webhook**，以便在 PDF 生成后自动推送消息到其他平台。
*   作为管理员，我希望平台 **提供简单的认证机制**，以保护应用管理后台。

# 4.  功能需求

### 4.1.  可视化应用管理

*   **创建应用:**
    *   允许用户填写应用名称和描述创建新的可视化应用。
    *   支持基于模板创建应用 (从已有的可视化应用另存为模板)。
*   **配置应用:**
    *   **数据源配置:**
        *   支持配置数据源类型：JSON 文件上传、TSV 文件上传、Excel 文件上传 (初步支持 CSV 格式，现代Excel表格例如 `.xlsx`  文件解析作为未来考虑)、API 配置 (URL)。
        *   数据源配置项包括：数据源类型选择、文件上传组件 (针对文件类型)、API URL 输入框 (针对 API 类型)。
        *   支持将数据源配置保存为“数据源引用”，方便在多个应用中复用。
    *   **图表引擎配置:**
        *   支持配置图表引擎来源：CDN URL、JS 文件上传。
        *   图表引擎配置项包括：引擎来源选择、CDN URL 输入框、JS 文件上传组件。
        *   支持将图表引擎配置保存为“脚本库引用”，方便复用。
    *   **图表配置脚本配置:**
        *   支持配置图表配置脚本来源：文本编辑器 (直接编辑 JSON/JS 脚本)、上传 JSON/JS 文件。
        *   图表配置脚本配置项包括：脚本来源选择、文本编辑器、文件上传组件。
        *   支持将图表配置脚本保存为“图表通用脚本”，方便复用。
*   **发布应用:**
    *   将配置好的可视化应用发布到平台，生成可访问的 URL。
*   **管理应用列表:**
    *   展示已发布的应用列表，包括应用名称、描述、发布时间等信息。
    *   提供应用的编辑、删除功能。
    *   提供应用预览功能 (在平台内查看可视化效果)。

### 4.2.  模板管理

*   **另存为模板:**  允许将已有的可视化应用另存为模板。
*   **模板列表:**  展示已保存的模板列表。
*   **基于模板创建:**  在创建应用时，可以选择基于模板创建。

### 4.3.  PDF 导出

*   **单应用 PDF 导出:**  在应用详情页提供按钮，点击后将当前可视化应用导出为 PDF 文件。
*   **Dashboard PDF 导出:**  在 Dashboard 页面提供按钮，点击后将 Dashboard 上展示的所有可视化应用导出到一个 PDF 文件 (每应用一页)。

### 4.4.  Dashboard

*   **Dashboard 创建:**  创建一个 Dashboard 页面，用于展示多个可视化应用。
*   **应用添加与拖拽排序:**  允许将已发布的可视化应用添加到 Dashboard，并支持拖拽排序应用在 Dashboard 上的位置。
*   **Dashboard 预览:**  展示 Dashboard 的预览效果。

### 4.5.  Webhook 集成

*   **Webhook 配置:**  在应用配置中提供 Webhook 配置项，允许用户配置 Webhook URL。
*   **PDF 文件推送:**  当用户触发 PDF 导出操作时 (单应用导出或 Dashboard 导出)，平台将生成的 PDF 文件作为 POST 请求的 body 发送到配置的 Webhook URL。
	*  Webhook 包含两步. 一是上传文件到指定的服务器, POST 请求, Content-Type: `application/pdf`,  Body: PDF 文件二进制数据。获得文件ID.
    *   **Webhook 请求格式:**  POST 请求, Content-Type: `application/pdf`,  Body: JSON格式化的内容, 包括, 文件ID, 和发送目标.

### 4.6.  认证

*   **管理员认证:**  平台提供简单的管理员认证功能。
*   **只有一个管理员账号:**  初期只设置一个管理员账号和密码 (硬编码或简单的环境变量配置)，用于登录管理后台。

# 5.  非功能性需求

*   **性能:**
	*   生成文件大小, 图表渲染应使用svg, 以便添加到PDF时, 保真且保证生成文件不超过webook的限制30M.
*   **易用性:**
    *   **操作简洁:**  平台操作流程应简洁直观，用户界面友好。
    *   **配置清晰:**  各项配置项应有清晰的说明和提示。
*   **可部署性:**
    *   **环境兼容:**  平台应能在企业私有云 (兼容 K8S 的 CCES) 环境中顺利部署和运行。
    *   **部署简单:**  部署过程应尽可能简单，例如使用 Docker 镜像部署。

# 6.  技术方案

## 6.1.  技术栈建议

*   **前端:**  SvelteKit
    *   **理由:**  SvelteKit 是一个全栈的 Web 应用框架，基于 Svelte5，轻量级、性能优秀，开发效率高，非常适合快速开发项目。它内置了路由、服务器端渲染等功能，可以简化前后端分离架构的复杂性，更符合 “全栈工程师” 的开发模式和 “受限时间” 的要求。
*   **后端:**  SvelteKit (Node.js)
    *   **理由:**  SvelteKit 本身就集成了后端能力，使用 Node.js 运行时环境，与前端 Svelte 无缝衔接，降低技术栈复杂性。Node.js 生态系统成熟，易于找到各种库和工具。
*   **数据存储:**  文件系统 或 SQLITE数据库 
    *   **理由:**  考虑到 “受限环境” 和 “允许数据丢失” 的条件，初期可以使用文件系统来存储应用配置、模板等数据。或者选择轻量级数据库，例如 SQLITE。这样可以避免依赖 外部的 数据库系统，简化部署和运维。
*   **图表库:**  ECharts, HighChart.js
    *   **理由:**  这些都是流行的 JavaScript 图表库，功能强大，社区活跃，用户可以根据需求选择合适的图表库，并通过 CDN 或上传的方式集成到平台中。
*   **PDF 生成库:**  jsPDF, pdfmake. 用于前端生成; 也可以用于后端生成(利用 Playwright)
    *   **理由:**  前端可以使用 jsPDF 或 pdfmake 等库在浏览器端生成 PDF然后发送到webhook，简单快捷。也可以考虑使用 Playwright 等工具在后端生成 PDF方便发送到webhook.

## 6.2.  系统架构 (简略)

*   **前端 (SvelteKit):**  负责用户界面展示、用户交互、应用配置管理、Dashboard 展示、PDF 前端生成 (可选)。
*   **后端 (SvelteKit):**  负责处理前端请求、数据存储和读取、PDF 后端生成 (可选)、Webhook 调用、认证等。
    **V1.0 阶段，为了快速开发和简化架构，建议采用 SvelteKit 全栈模式，并尽量在 SvelteKit 应用内部处理后端逻辑，不强制设置独立的 API 层。**
*   **数据存储:**  存储可视化应用配置、模板、数据源引用、脚本库引用、通用脚本等数据。

## 6.3.  API 接口 (可选, 如果有)

*   `/api/apps`:  可视化应用管理 API
    *   `GET /api/apps`:  获取应用列表
    *   `POST /api/apps`:  创建应用
    *   `GET /api/apps/{appId}`:  获取应用详情
    *   `PUT /api/apps/{appId}`:  更新应用
    *   `DELETE /api/apps/{appId}`:  删除应用
    *   `POST /api/apps/{appId}/pdf`:  导出应用为 PDF
*   `/api/templates`:  模板管理 API
    *   `GET /api/templates`:  获取模板列表
    *   `GET /api/templates/{templateId}`:  获取模板
    *   `POST /api/templates`:  创建模板 (另存为模板)
*   `/api/dashboards`: Dashboard 管理 API (可选，如果 Dashboard 功能作为独立实体)
    *   ... 略

# 7.  文件结构 (建议)
```yaml
project-root/  
├── src/  
│   ├── lib/ # 通用库代码 (components, utils, stores 等)  
│   │   ├── components/ # Svelte 组件  
│   │   ├── utils.js # 工具函数  
│   │   ├── stores.js # Svelte stores (状态管理)  
│   ├── routes/ # 路由页面  
│   │   ├── api/ # 后端 API 路由 (SvelteKit API routes)  
│   │   │   ├── apps/  
│   │   │   │   ├── index.js # GET /api/apps, POST /api/apps  
│   │   │   │   ├── [appId].js # GET /api/apps/{appId}, PUT/DELETE /api/apps/{appId}  
│   │   │   │   └── [appId]/pdf.js # POST /api/apps/{appId}/pdf  
│   │   │   └── templates/  
│   │   │       └── index.js # GET /api/templates, POST /api/templates  
│   │   ├── apps/ # 可视化应用管理页面  
│   │   │   ├── +page.svelte  
│   │   │   ├── +page.server.svelte
│   │   │   └── [appId]/  
│   │   │       └── +page.svelte # 应用详情页  
│   │   ├── dashboard/ # Dashboard 页面  
│   │   │   └─ +page.svelte  
│   │   ├── datasouce/ # 数据源要素管理
│   │   │   ├── +page.server.svelte
│   │   │   ├── +page.svelte  
│   │   │   └── [datasourceId]/  
│   │   │       ├── +page.server.svelte
│   │   │       └── +page.svelte # 数据源详情页  
│   │   ├── login/ # 登录页面  
│   │   │   └── +page.svelte  
│   │   ├── scripts/ # 脚本要素管理
│   │   │   ├── +page.server.svelte
│   │   │   ├── +page.svelte  
│   │   │   └── [scriptId]/  
│   │   │       ├── +page.server.svelte
│   │   │       └── +page.svelte # 应用详情页  
│   │   ├── templates/ # 可视化应用模板管理页面  
│   │   │   ├── +page.server.svelte
│   │   │   ├── +page.svelte  
│   │   │   └── [appId]/  
│   │   │       ├── +page.server.svelte
│   │   │       └── +page.svelte # 应用详情页  
│   │   ├── +layout.svelte # 根布局  
│   │   └── +page.svelte # 首页 (可选，例如 Dashboard 或应用列表)  
│   ├── app.html # HTML 模板  
│   └── data/ # (可选) 存储文件数据源, 脚本库, 通用脚本等 (如果使用文件系统存储)  
├── static/ # 静态资源 (例如上传的 JS 库, 图标等)  
├── svelte.config.js # SvelteKit 配置文件  
├── package.json  
├── tsconfig.json
├── svelte.config.js
├── README.md  
└── ...
```


# 8.  未来迭代方向 (V2.0 展望)

*   **更丰富的数据源支持:**  支持直接连接数据库 (例如 MySQL, PostgreSQL) 查询数据。
*   **更强大的图表库集成:**  预置更多图表库，提供更丰富的图表类型和配置选项。
*   **在线可视化编辑器:**  提供拖拽式的可视化编辑器，降低用户使用门槛。
*   **细粒度的权限管理:**  实现用户角色和权限管理，支持多人协作。
*   **完善的持久化方案:**  采用成熟的数据库系统，实现数据的可靠持久化存储。
*   **更丰富的 Dashboard 功能:**  例如，支持 Dashboard 布局定制、应用间数据联动等。
*   **监控和告警:**  增加平台运行状态监控和告警功能。

# 9.  附录

*   **术语表:**
    *   **可视化应用:**  指基于数据和图表引擎生成的可视化展示页面。
    *   **数据源:**  可视化应用的数据来源，可以是 JSON/TSV/Excel 文件、API 接口等。
    *   **图表引擎:**  用于绘制图表的 JavaScript 库，例如 ECharts, HighChart.js。
    *   **图表配置脚本:**  基于数据和图表引擎，配置图表样式和行为的 JSON 或 JS 脚本。
    *   **图表库CDN URL引用:**  预先保存的图表引擎配置，可以在多个可视化应用中复用。
    *   **数据源引用:**  预先保存的数据源配置，可以在多个可视化应用中复用。
    *   **图表通用脚本:** 预先保存的图表配置脚本，可以在多个可视化应用中复用。
    *   **Dashboard:**  用于集中展示和管理多个可视化应用的页面。
    *   **Webhook:**  一种 Web 回调技术，用于在事件发生时自动向指定 URL 发送消息。

---

**PRD 结束**

