# 推送机器人配置说明

## 使用方式
http://imtwo.zdxlz.com/im-external/v1/webhook/send?key=6989691348998302941

在终端某个群组添加机器人之后，创建者可以在机器人详情页看到该机器人特有的webhookurl。**（特别注意：一定要保护好机器人的webhook地址，避免泄露！）**开发者可以按以下说明向这个地址发起HTTP POST 请求，即可实现通过HTTP发送群消息。 以下是用curl工具往群组推送文本消息的示例（注意要将url替换成你的机器人webhook地址，content必须是utf8编码）

```bash
curl -X POST --location "http://imtwo.zdxlz.com/im-external/v1/webhook/send?key=6989691348998302941" \
    -H "Content-Type: application/json" \
    -d '{
            "type": "text",
            "textMsg": {
                "content": "合肥今日天气：29度，大部分多云，降雨概率：60%"
            }
        }'
```

- 当前自定义机器人支持文本（text）、图片（image）、 图文（news） 、文件（file）四种消息类型。

## 消息类型及数据格式

### 文本类型

- 效果

图片不可见(https://imfl.zdxlz.com/im-file/v1/files/common?fileId=e1b1db25e47045f682ea6e0c039294cc)

- 请求示例

```json
{
    "type": "text",
    "textMsg": {
        "content": "合肥今日天气：29度，大部分多云，降雨概率：60%",
        "isMentioned":true,
        "mentionType":2,
        "mentionedMobileList":["18907191365","18907191064"]
    }
}
curl -X POST --location "http://imtwo.zdxlz.com/im-external/v1/webhook/send?key=6989691348998302941" \
    -H "Content-Type: application/json" \
    -d '{
            "type": "text",
            "textMsg": {
                "content": "来自王新海的PC测试消息, 群成员至少3人...",
                "isMentioned":true,
		        "mentionType":2,
		        "mentionedMobileList":["18907191365","18907191064"]
            }
        }'
```

|参数|是否必填|说明|
|---|---|---|
|type|是|消息类型，此时固定为text|
|content|是|消息内容|
|isMentioned|否|是否包含@功能，true为包含，false为不包含|
|mentionType|否|@类型，1为@所有人，2为@部分人，isMentioned为true则必填|
|mentionedMobileList|否|@人员的手机号，mentionType为2则必填|


### 图文类型

- 效果
(https://imfl.zdxlz.com/im-file/v1/files/common?fileId=4d72bfb744564f3e9c06bccaa35826a3)

- 请求示例

```json
{
      "type": "news",
      "news": {
        "info": {
          "title": "今年春节有好礼相送",
          "description": "点击图片领取礼品",
          "url": "https://www.baidu.com",
          "picUrl": "http://img.sccnn.com/bimg/341/34669.jpg"
        }
      }
 }
```

|参数|是否必填|说明|
|---|---|---|
|type|是|消息类型，此时固定为news|
|title|是|标题，不超过128个字节，超过会自动截断|
|description|否|描述，不超过512个字节，超过会自动截断|
|url|是|点击后跳转的链接。|
|picUrl|否|图片的链接。|

### 多媒体类型
#### 图片类型

- 效果
***图片上传地址***
(https://imfl.zdxlz.com/im-file/v1/files/common?fileId=9180e96faadc423ebd31ce18f837c890)

- 请求示例

```bash
curl -X POST --location "http://imtwo.zdxlz.com/im-external/v1/webhook/send?key=6989691348998302941" \
    -H "Content-Type: application/json" \
    -d '{
      "type":"image",
      "imageMsg":{
        "fileId":"31f42a827c65443c8bc25f9d9e5d91e4",
        "height": 455,
        "width": 1296
      }
  }'
```

| 参数     | 是否必填 | 说明              |
| ------ | ---- | --------------- |
| type   | 是    | 消息类型，此时固定为image |
| fileId | 是    | 图片上传返回的fileId。  |
| height | 是    | 图片高度。           |
| width  | 是    | 图片宽度。           |

#### 文件类型

```json
{
    "type": "file",
    "fileMsg": { 
        "fileId": "fileId"
    }
}
```

|参数|是否必填|说明|
|---|---|---|
|type|是|消息类型，此时固定为file|
|fileId|是|文件id，通过下文的文件上传接口获取。|

#### 文件上传接口

##### 请求方式

- POST

##### 请求方式

- POST
- 请求地址：`https://imtwo.zdxlz.com/im-external/v1/webhook/upload-attachment?key=KEY&type=TYPE`
- 使用multipart/form-data POST上传文件

##### 请求头参数

| 参数名  | 必选  | 类型     | 说明      |
| :--- | :-- | :----- | ------- |
| key  | 是   | string | 该机器人key |
| type | 是   | int    | 对应文件类型  |
| file | 是   | file   | 文件二进制流  |

##### 文件类型枚举

|参数名|说明|
|:--|---|
|1|图片|
|2|文件|
- 请求示例
    
```bash
# type=*/*
export KEY='6989691348998302941'
curl -X POST --location "https://imtwo.zdxlz.com/im-external/v1/webhook/upload-attachment?key=$KEY&type=1" \
-H "Content-Type: multipart/form-data; boundary=WebAppBoundary" \
-F "file=@d:\Users\Administrator\Pictures\1.jpg;filename=1.jpg;type=image/png"
    ```
    
#### 返回参数

| 参数名  | 必选  | 类型     | 说明                |
| :--- | :-- | :----- | ----------------- |
| id   | 是   | String | 文件id              |
| name | 是   | String | 文件名称              |
| type | 是   | String | 文件类型.zip,.txt ... |
| size | 是   | String | 文件大小              |


- 返回数据
    
    ```json
    {
          "ok": true,
          "code": 200,
          "data": {
            "id": "ce34fd4a5b0043efa86c37b33e4da0ca", //文件id
            "name": "test.jpg",
            "type": ".jpg",
            "size": 318182
          },
          "message": "成功"
    }
    ```
    

**上传文件限制**

- **文件大小不超过30M**

## 消息发送频率限制

**每个机器人发送的消息不能超过20条/分钟。**


# 接受机器人

# IM发送到第三方机器人的消息格式

## 消息数据格式文本

```json
{

    "type": "text",

    "callBackUrl": "https://impre.zdxlz.com/im-external/v1/webhook/send?key=1234567890", // 回调url

    "callBackMethod": "POST", // 回调请求方式

    "phone":"18800001111",

    "groupId":"123456",

    "tenantId": 1,   //租户id，不传默认为1
    
    "robotId":"aaa123456", //对话机器人id

    "textMsg": {

                "content": "查询合肥天气"

        }

}
```

# 第三方将结果发送给IM的回调接口

## 使用方式

#### 1.对话消息

##### 1.1 文本消息

```json
curl -X POST --location "https://{host}/im-external/v1/webhook/send?key=1234567890" \
    -H "Content-Type: application/json" \
    -d '{
    "type": "text",
    "textMsg": {
    "content": "合肥今日天气：29度，大部分多云，降雨概率：60%",
        "isMentioned":true,                     //是否包含@
        "mentionType":2,
        "mentionedMobileList":["18800001111"], //IM发送的phone
        "groupId":"123456"                     //IM发送的groupId
        
    }
}'
```

##### 1.2 图片消息

```json
curl -X POST --location "https://{host}/im-external/v1/webhook/send?key=1234567890" \
    -H "Content-Type: application/json" \
    -d '{
    "type": "image",
    "imageMsg": {
        "fileId":"aa11bb22cc33",
        "height": 455,
        "width": 1296,
        "groupId":"123456",       				 //IM发送的groupId
        "isMentioned":true,						 //是否包含@
        "mentionedMobileList":["18800001111"]	 //IM发送的phone
        
    }
}'
```

##### 1.3 文件消息

```json
curl -X POST --location "https://{host}/im-external/v1/webhook/send?key=1234567890" \
    -H "Content-Type: application/json" \
    -d '{
    "type": "file",
    "fileMsg":{
        "fileId":"aa11bb22cc33",
        "groupId":"123456",
        "isMentioned":true,
        "mentionedMobileList":["18800001111"]
      }        
    }
}'
```

**说明**：

如果为对话机器人，IM会调用第三方接口，把回调地址callBackUrl、提问人手机号phone、提问人所在群组groupId、租户id和需要提问的信息发送给第三方机器人，第三方机器人按上述格式发送给回调接口。

其中，isMentioned : 是否包含@，此时固定为true；

mentionType：1为@所有人，2为@部分人，此时固定为2；（图片消息、文件消息不需要这个字段）；

mentionedMobileList ：为@人员的手机号列表，此时为唯一的IM发送的"phone"；

groupId : 为消息发送到的群组id，此时为IM发送的groupId。

#### 2.推送消息

```json
curl -X POST --location "https://{host}/im-external/v1/webhook/send?key=1234567890" \
    -H "Content-Type: application/json" \
    -d '{
    "type": "text",
    "textMsg": {
    "content": "合肥今日天气：29度，大部分多云，降雨概率：60%",
    "isMentioned":true,                     //是否包含@
    "mentionType":2,
    "mentionedMobileList":["18800001111","18800002222"],                   
    }

}'
```

**说明：**

推送消息和推送机器人功能相同，可以发送文本、图片、文件等，具体配置参考推送机器人说明文档。