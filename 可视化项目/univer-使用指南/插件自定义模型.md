
Univer 允许用户将自定义插件中的数据跟随 `snapshot` 一起 #落盘 或 #加载元数据。

## 创建一个 CustomerService[](https://docs.univer.ai/zh-CN/guides/sheets/advanced/custom-model#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA-customerservice)

在 `@univerjs/core` 中存在一个 `ResourceManagerService` 实例，你可以在自己新建的 plugin 中注册对应的 `hook`，将数据绑定到 `snapshot` 上。

```ts
import { IResourceManagerService, Inject, LifecycleStages } from '@univerjs/core';
import { UniverType } from '@univerjs/protocol';
 
interface IResource { 
	testResource: string 
}
 
class MyCustomService {
  private _model: IResource = { testResource: '' };
 
  constructor(
    // 依赖注入点. 插件资源 管理服务
    @Inject(IResourceManagerService) private _resourceManagerService: IResourceManagerService
  ) {
    this._resourceManagerService.registerPluginResource<IResource>({
      toJson: (_unitId?: string) => this._toJson(_unitId), // 保存
      parseJson: (json: string) => this._parseJson(json), // 解析
      pluginName: 'SHEET_CustomerService_PLUGIN', // 自定义插件. 注意这里面的命名拼写
      // 业务
      businesses: [UniverType.UNIVER_SHEET, UniverType.UNIVER_DOC, UniverType.UNIVER_SLIDE],
      onLoad: (_unitId: string, resource: IResource) => {
        this._model = resource;
      },
      // 卸载
      onUnLoad: (_unitId: string) => {
        this._model = { testResource: '' };
      },
    });
  }
 
  private _toJson(_unitId: string) {
    const model = this._model;
    return JSON.stringify(model);
  }
 
  private _parseJson(json: string) {
    return JSON.parse(json);
  }
}
```

1. `IResource` 的类型可以自己随意定义，支持任何类型。
2. `toJson/parseJson` 是一对针对 `IResource` 的序列化函数，通常使用 JSON 函数，这里你也可以可以加入压缩/混淆的特定逻辑。
3. `toJson` 的函数参数为什么会有 `unitId`? 
    这是因为 一个 `Univer` 实例可能会包含多个 `unit` 实例 #unit实例 `Sheet`/`Doc`/ `Slider`）
    `onLoad`/`onUnLoad` 同理。
4. `businesses` 这个选项，是指明使用场景. *trigger on*`

## 注入 CustomerPlugin[](https://docs.univer.ai/zh-CN/guides/sheets/advanced/custom-model#%E6%B3%A8%E5%85%A5-customerplugin)

当你的数据已经接入 `ResourceManagerService` 后，将你的 `MyCustomService` 在你自己的 `MyCustomSheetPlugin` 中注入

```ts
import { Plugin, Inject, Injector } from '@univerjs/core'; 
export class MyCustomSheetPlugin extends Plugin {
  constructor(
    // 依赖注入. 注入 自定义的 CustomService, 也就是把 IResourceManagerService 注入到 CustomService 实例中
    @Inject(Injector) override readonly _injector: Injector
  ) {
    super();
    this._injector.add([MyCustomService]);
  }
}
```

最终
## 将插件注册进 Univer
```ts
const univer = new Univer();
univer.registerPlugin(MyCustomSheetPlugin);
// 执行其他的初始化逻辑
```


## 如何获得包含`Resources`资源的快照[](https://docs.univer.ai/zh-CN/guides/sheets/advanced/custom-model#%E5%A6%82%E4%BD%95%E8%8E%B7%E5%BE%97%E5%8C%85%E5%90%ABresources%E8%B5%84%E6%BA%90%E7%9A%84%E5%BF%AB%E7%85%A7)

在 `@univerjs/core` 中存在一个 `ResourceLoaderService` 实例，你可以通过该 `Service` 的 
`saveWorkbook` 或者 `saveDoc` 获得最新快照信息 `Snapshot`，后续再通过 `univer.createUnit` 来回显数据。
其中 `Resource` 信息存储在 `snapshot.resources` 上，可根据对应的 `pluginName` 去获取。

```ts
import { IResourceLoaderService, IUniverInstanceService, Inject, LifecycleStages } from '@univerjs/core';
import { UniverType } from '@univerjs/protocol';
 
class MyCustomService {
  constructor(
    @Inject(IResourceLoaderService) private _resourceLoaderService: IResourceLoaderService,
    @Inject(IUniverInstanceService) private _univerInstanceService: IUniverInstanceService,
    // 依赖注入点. 插件资源 管理服务
    @Inject(IResourceManagerService) private _resourceManagerService: IResourceManagerService
 
  ) {
    const workbook = this._univerInstanceService.getCurrentUnitForType(UniverType.UNIVER_SHEET)!
    const snapshot = this._resourceLoaderService.saveUnit(workbook.getUnitId());
    
    this._resourceManagerService.registerPluginResource<IResource>({
      toJson: (_unitId?: string) => this._toJson(_unitId), // 保存
      parseJson: (json: string) => this._parseJson(json), // 解析
      pluginName: 'SHEET_CustomerService_PLUGIN', // 自定义插件. 注意这里面的命名拼写
      // 业务
      businesses: [UniverType.UNIVER_SHEET, UniverType.UNIVER_DOC, UniverType.UNIVER_SLIDE],
      onLoad: (_unitId: string, resource: IResource) => {
        this._model = resource;
        // TODO 解析. 填入内容
      },
      // 卸载
      onUnLoad: (_unitId: string) => {
        this._model = { testResource: '' };
      },
    });
  }
  private _toJson(_unitId: string) {
    const model = this._model;
    return JSON.stringify(model);
  }
 
  private _parseJson(json: string) {
    return JSON.parse(json);
  }
}
```